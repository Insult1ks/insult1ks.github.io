<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no">
    <title>volumeshader_bm</title>
    <style>
        body {
            background: #131115;
        }
        #c1 {
            background: #fbf7fe;
            position: fixed;
            left: 0px;
            top: 0px;
        }
        #main {
            transform-origin: 0px 0px;
            position: fixed;
            left: 0px;
            top: 0px;
        }
    </style>
</head>
<body style="overflow-x:hidden;overflow-y:hidden">
    <div id="main">
        <canvas id="c1" width="1024" height="1024">
            <span>不支持canvas浏览器</span>
        </canvas>
    </div>
    <script>
        var cx, cy;
        var glposition, glright, glforward, glup, glorigin, glx, gly, gllen;
        var canvas, gl;
        var date = new Date();
        var md = 0, mx, my;
        var t2, t1 = date.getTime();
        var mx = 0, my = 0, mx1 = 0, my1 = 0, lasttimen = 0;
        var ml = 0, mr = 0, mm = 0;
        var len = 1.6;
        var ang1 = 2.8;
        var ang2 = 0.4;
        var cenx = 0.0, ceny = 0.0, cenz = 0.0;

        function ontimer() {
            ang1 += 0.01;
            draw();
            window.requestAnimationFrame(ontimer);
        }

        document.addEventListener("mousedown", function (ev) {
            if (ev.button == 0) ml = 1;
            if (ev.button == 2) mr = 1;
            mx = ev.clientX;
            my = ev.clientY;
        }, false);

        document.addEventListener("mouseup", function (ev) {
            if (ev.button == 0) ml = 0;
            if (ev.button == 2) mr = 0;
        }, false);

        document.addEventListener("mousemove", function (ev) {
            if (ml == 1) {
                ang1 += (ev.clientX - mx) * 0.002;
                ang2 += (ev.clientY - my) * 0.002;
                if (ev.clientX != mx || ev.clientY != my) mm = 1;
            }
            if (mr == 1) {
                var l = len * 4.0 / (cx + cy);
                cenx += l * (-(ev.clientX - mx) * Math.sin(ang1) - (ev.clientY - my) * Math.sin(ang2) * Math.cos(ang1));
                ceny += l * ((ev.clientY - my) * Math.cos(ang2));
                cenz += l * ((ev.clientX - mx) * Math.cos(ang1) - (ev.clientY - my) * Math.sin(ang2) * Math.sin(ang1));
                if (ev.clientX != mx || ev.clientY != my) mm = 1;
            }
            mx = ev.clientX;
            my = ev.clientY;
        }, false);

        document.addEventListener("mousewheel", function (ev) {
            ev.preventDefault();
            len *= Math.exp(-0.001 * ev.wheelDelta);
        }, false);

        document.oncontextmenu = function (event) {
            if (mm == 1) event.preventDefault();
        };

        function draw() {
            date = new Date();
            var t2 = date.getTime();
            t1 = t2;
            gl.uniform1f(glx, cx * 2.0 / (cx + cy));
            gl.uniform1f(gly, cy * 2.0 / (cx + cy));
            gl.uniform1f(gllen, len);
            gl.uniform3f(glorigin, len * Math.cos(ang1) * Math.cos(ang2) + cenx, len * Math.sin(ang2) + ceny, len * Math.sin(ang1) * Math.cos(ang2) + cenz);
            gl.uniform3f(glright, Math.sin(ang1), 0, -Math.cos(ang1));
            gl.uniform3f(glup, -Math.sin(ang2) * Math.cos(ang1), Math.cos(ang2), -Math.sin(ang2) * Math.sin(ang1));
            gl.uniform3f(glforward, -Math.cos(ang1) * Math.cos(ang2), -Math.sin(ang2), -Math.sin(ang1) * Math.cos(ang2));
            gl.drawArrays(gl.TRIANGLES, 0, 6);
            gl.finish();
        }

        window.onresize = function () {
            cx = document.body.clientWidth;
            cy = document.body.clientHeight;
            if (cx > cy) cx = cy;
            else cy = cx;
            document.getElementById("main").style.width = "1024px";
            document.getElementById("main").style.height = "1024px";
            document.getElementById("main").style.transform = "scale(" + cx / 1024 + "," + cy / 1024 + ")";
        };

        window.onload = function () {
            cx = document.body.clientWidth;
            cy = document.body.clientHeight;
            if (cx > cy) cx = cy;
            else cy = cx;
            document.getElementById("main").style.width = "1024px";
            document.getElementById("main").style.height = "1024px";
            document.getElementById("main").style.transform = "scale(" + cx / 1024 + "," + cy / 1024 + ")";
        };
    </script>
</body>
</html>
